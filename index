import crypto from "crypto";
import fetch from "node-fetch"; // remova esta linha se estiver usando Node 18+

const META_URL = "https://graph.facebook.com/v24.0/813835741312840/events";
const ACCESS_TOKEN = "EAAQhx9XAvpUBPyUE8UU687nRIu99wwNxehI9VpuXp88KuFP10mTsXMKMZBjeVS6cPE5ZBDgLw8FUfFjkouVCJJSL9q6187qpARewfmSrjt9XQNeTejNR2ZBZCkPlcO46q8S2fGl7byB4WIVSzDwQdGw7T0S7LHvYEVApsrjZC4d9gJJO4wGOj4K9JZAgJOqbUNZAQZDZD";

// Fun√ß√£o para fazer hash (obrigat√≥rio pela Meta)
function hash(value) {
  if (!value) return "";
  return crypto.createHash("sha256").update(value.trim().toLowerCase()).digest("hex");
}

export async function enviarLeadParaMeta(lead) {
  const payload = {
    data: [
      {
        event_name: "Lead",
        event_time: Math.floor(Date.now() / 1000),
        action_source: "system_generated",
        custom_data: {
          lead_event_source: "Bitrix24",
          lead_id: lead.ID
        },
        user_data: {
          em: [hash(lead.EMAIL)],
          ph: [hash(lead.PHONE)]
        }
      }
    ]
  };

  try {
    const response = await fetch(`${META_URL}?access_token=${ACCESS_TOKEN}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (!response.ok) {
      console.error("‚ùå Erro ao enviar para Meta:", result);
    } else {
      console.log("‚úÖ Lead enviado com sucesso para Meta:", result);
    }
  } catch (error) {
    console.error("üö® Erro na requisi√ß√£o:", error);
  }
}
